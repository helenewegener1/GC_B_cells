pivot_longer(cols = starts_with("Fol"), names_to = "ADT", values_to = "CLR") %>%
mutate(ADT_CLR_mean = glue('{ADT} CLR_mean: {round(adt_summary[ADT,"mean_CLR"], 2)}')) %>%
ggplot(aes(x = CLR, fill = ADT_CLR_mean)) +
geom_density(alpha = 0.5) +
facet_wrap(vars(ADT_CLR_mean)) +
theme_bw() +
theme(legend.position = "none")
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/ADT_CLR_values_density.png"), width = 10, height = 7)
# CLR value range
ADT_exprs <- seurat_obj[["ADT"]]$counts %>% rowSums()
fols <- rownames(seurat_obj[["ADT"]]$data)
for (fol in fols){
# fol <- "Fol-1"
ADT_exp <- format(ADT_exprs[fol], big.mark = ",")
seurat_obj[["ADT"]]$data %>% t() %>% as.data.frame() %>%
pivot_longer(cols = starts_with("Fol"), names_to = "ADT", values_to = "CLR") %>%
mutate(ADT_CLR_mean = glue('{ADT} CLR_mean: {round(adt_summary[ADT,"mean_CLR"], 2)}')) %>%
filter(ADT == fol) %>%
ggplot(aes(x = CLR, fill = ADT_CLR_mean)) +
geom_density(alpha = 0.5) +
# facet_wrap(vars(ADT_CLR_mean)) +
scale_x_continuous(
breaks = seq(0, max(seurat_obj[["ADT"]]$data[fol, ]), by = 0.2)  # adjust 0.2 as needed
) +
theme_bw() +
theme(legend.position = "none") +
labs(title = fol,
subtitle = glue("Summed ADT counts: {ADT_exp}"))
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/CLR_values_per_fol/{fol}_ADT_CLR_values_density.png"), width = 14, height = 6)
# log CLR range
seurat_obj[["ADT"]]$data %>% t() %>% as.data.frame() %>%
pivot_longer(cols = starts_with("Fol"), names_to = "ADT", values_to = "CLR") %>%
mutate(ADT_CLR_mean = glue('{ADT} CLR_mean: {round(adt_summary[ADT,"mean_CLR"], 2)}')) %>%
filter(ADT == fol) %>%
ggplot(aes(x = CLR, fill = ADT_CLR_mean)) +
geom_density(alpha = 0.5) +
scale_x_continuous(trans = "log", breaks = scales::log_breaks(n = 40)) +
# scale_x_continuous(
#   breaks = seq(-5, 5, by = 0.2),  # adjust 0.2 as needed
#   sec.axis = sec_axis(~exp(.), name = "Original CLR")
# ) +
theme_bw() +
theme(legend.position = "none") +
labs(title = fol,
subtitle = glue("Summed ADT counts: {ADT_exp}"))
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/CLR_values_per_fol/{fol}_ADT_log_CLR_values_density.png"), width = 16, height = 6)
}
############################## Manual threshold ################################
# three thresholds <- cut_close_to_noise, cut_in_middle, cut_close_to_signal
cut_close_to_noise_thresholds <- c(
"Fol-1" = 1.75,
"Fol-2" = 1.8,
"Fol-3" = 1.5,
"Fol-4" = 1.4,
"Fol-5" = 1.3,
"Fol-6" = 1.75,
"Fol-7" = 1.7,
"Fol-8" = 1.4,
"Fol-9" = 2.25,
"Fol-10" = 2,
"Fol-11" = 1.4,
"Fol-12" = 1.2,
"Fol-13" = 1.2,
"Fol-14" = 1.5,
"Fol-15" = 1.75,
"Fol-16" = 2.5,
"Fol-17" = 1.5,
"Fol-18" = 1.25
)
cut_in_middle_thresholds <- c(
"Fol-1" = 2,
"Fol-2" = 2.1,
"Fol-3" = 2,
"Fol-4" = 1.74,
"Fol-5" = 1.5,
"Fol-6" = 2,
"Fol-7" = 2.4,
"Fol-8" = 1.75,
"Fol-9" = 2.75,
"Fol-10" = 2.75,
"Fol-11" = 1.75,
"Fol-12" = 1.4,
"Fol-13" = 1.3,
"Fol-14" = 2.5,
"Fol-15" = 2.75,
"Fol-16" = 3.50,
"Fol-17" = 2,
"Fol-18" = 1.5
)
cut_close_to_signal_thresholds <- c(
"Fol-1" = 2.5,
"Fol-2" = 2.2,
"Fol-3" = 2.75,
"Fol-4" = 2.25,
"Fol-5" = 1.6,
"Fol-6" = 2.3,
"Fol-7" = 3.3,
"Fol-8" = 2,
"Fol-9" = 3.75,
"Fol-10" = 3.25,
"Fol-11" = 2,
"Fol-12" = 1.6,
"Fol-13" = 1.4,
"Fol-14" = 3,
"Fol-15" = 3.5,
"Fol-16" = 4.5,
"Fol-17" = 2.5,
"Fol-18" = 1.75
)
# ---------- UNIVERSAL FUNCTION ----------
manual_call <- function(clr_matrix, thresholds) {
# Boolean matrix: ADT > threshold ?
pos_matrix <- sweep(clr_matrix, 1, thresholds, FUN = ">")
# How many ADTs positive per cell
pos_counts <- colSums(pos_matrix)
# Initialize calls
cell_id <- rep("Negative", ncol(clr_matrix))
# For singlets: pick the ADT with highest CLR *among positives*
is_singlet <- pos_counts == 1
if (any(is_singlet)) {
# Pick exactly the row where pos_matrix is TRUE
singlet_ADT <- apply(pos_matrix[, is_singlet, drop = FALSE], 2,
function(x) rownames(pos_matrix)[which(x)])
cell_id[is_singlet] <- singlet_ADT
}
# Doublets
cell_id[pos_counts > 1] <- "Doublet"
# Classification column
classification <- ifelse(cell_id == "Negative", "Negative",
ifelse(cell_id == "Doublet", "Doublet", "Singlet"))
return(list(id = cell_id, class = classification))
}
# ---------- APPLY TO ALL 3 THRESHOLD SETS ----------
# 1) close to noise
res_noise <- manual_call(clr_counts, cut_close_to_noise_thresholds)
seurat_obj$manual_ADT_ID_cut_close_to_noise <- res_noise$id
seurat_obj$manual_ADT_class_cut_close_to_noise <- res_noise$class
seurat_obj$manual_ADT_class_cut_close_to_noise %>% table()
# 2) middle
res_middle <- manual_call(clr_counts, cut_in_middle_thresholds)
seurat_obj$manual_ADT_ID_cut_in_middle <- res_middle$id
seurat_obj$manual_ADT_class_cut_in_middle <- res_middle$class
seurat_obj$manual_ADT_class_cut_in_middle %>% table()
# 3) close to signal
res_signal <- manual_call(clr_counts, cut_close_to_signal_thresholds)
seurat_obj$manual_ADT_ID_cut_close_to_signal <- res_signal$id
seurat_obj$manual_ADT_class_cut_close_to_signal <- res_signal$class
seurat_obj$manual_ADT_class_cut_close_to_signal %>% table()
# clr_counts <- seurat_obj[["ADT"]]$data
#
# # Initialize empty matrix to store positive calls
# pos_matrix <- matrix(0, nrow = nrow(clr_counts), ncol = ncol(clr_counts),
#                      dimnames = dimnames(clr_counts))
#
# # Loop through hashtags and apply threshold
# for (h in rownames(clr_counts)) {
#   pos_matrix[h, ] <- clr_counts[h, ] > cut_close_to_noise_thresholds[h]
# }
#
# # Count positives per cell
# pos_counts <- colSums(pos_matrix)
#
# # Assign singlet/doublet/negative
# cell_class <- rep("Negative", ncol(clr_counts))
# cell_class[pos_counts == 1] <- rownames(pos_matrix)[apply(pos_matrix, 2, which.max)][pos_counts == 1]
# cell_class[pos_counts > 1] <- "Doublet"
#
# cell_class %>% table()
#
# # Insert manual ADT demultplexing in seurat object
# seurat_obj$manual_ADT_ID_cut_close_to_noise_thresholds <- cell_class
# seurat_obj$manual_ADT_classification_cut_close_to_noise_thresholds <- seurat_obj$manual_ADT_ID %>% str_replace("Fol-\\d+", "Singlet")
############################### Compare to tools ###############################
seurat_obj$ADT_ID %>% table()
seurat_obj$MULTI_ID_0.7 %>% table()
seurat_obj$MULTI_ID_autoThresh %>% table()
df_compare_demux <- list(
# DIY = cell_class %>% table(),
manual_ADT_ID_cut_close_to_noise = seurat_obj$manual_ADT_ID_cut_close_to_noise %>% table(),
manual_ADT_ID_cut_in_middle = seurat_obj$manual_ADT_ID_cut_in_middle %>% table(),
manual_ADT_ID_cut_close_to_signal = seurat_obj$manual_ADT_ID_cut_close_to_signal %>% table(),
HTO_0.999 = seurat_obj$ADT_ID %>% table(),
MULTI_ID_0.7 = seurat_obj$MULTI_ID_0.7 %>% table(),
MULTI_ID_autoThresh = seurat_obj$MULTI_ID_autoThresh %>% table()
) %>%
bind_rows(.id = "Method") %>%         # Method column
as.data.frame()
df_compare_demux_long <- df_compare_demux %>% pivot_longer(cols = !Method,
names_to = "class",
values_to = "count")
df_compare_demux <- df_compare_demux %>% mutate(N_drop_outs = Doublet + Negative)
text_box = glue(
"
N drop out
Manual cut close to noise: {df_compare_demux[df_compare_demux$Method == 'manual_ADT_ID_cut_close_to_noise', 'N_drop_outs']}
Manual cut close to middle: {df_compare_demux[df_compare_demux$Method == 'manual_ADT_ID_cut_in_middle', 'N_drop_outs']}
Manual cut close to signal: {df_compare_demux[df_compare_demux$Method == 'manual_ADT_ID_cut_close_to_signal', 'N_drop_outs']}
HTO_0.999: {df_compare_demux[df_compare_demux$Method == 'HTO_0.999', 'N_drop_outs']}
MULTI_ID_0.7: {df_compare_demux[df_compare_demux$Method == 'MULTI_ID_0.7', 'N_drop_outs']}
MULTI_ID_autoThresh: {df_compare_demux[df_compare_demux$Method == 'MULTI_ID_autoThresh', 'N_drop_outs']}
"
)
# Bar plot comparing tools
library(wesanderson)
df_compare_demux_long %>%
ggplot(aes(y = class, x = count, fill = Method)) +
geom_col(position = "dodge") +
theme_bw() +
# scale_fill_manual(values = c("hotpink", "blue4", "green4", "red4"))
scale_fill_manual(values = c(wes_palette("Moonrise3", n = 5), wes_palette("Moonrise2", n = 2)[2])) +
annotate("text", x=2500, y=10, label= text_box)
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/ADT_barplot_manual_VS_tool.png"), width = 10, height = 7)
# Bar plot only manual
text_box = glue(
"
N drop out
Manual cut close to noise: {df_compare_demux[df_compare_demux$Method == 'manual_ADT_ID_cut_close_to_noise', 'N_drop_outs']}
Manual cut close to middle: {df_compare_demux[df_compare_demux$Method == 'manual_ADT_ID_cut_in_middle', 'N_drop_outs']}
Manual cut close to signal: {df_compare_demux[df_compare_demux$Method == 'manual_ADT_ID_cut_close_to_signal', 'N_drop_outs']}
"
)
df_compare_demux_long %>%
filter(startsWith(Method, "manual")) %>%
ggplot(aes(y = class, x = count, fill = Method)) +
geom_col(position = "dodge") +
theme_bw() +
# scale_fill_manual(values = c("hotpink", "blue4", "green4", "red4"))
scale_fill_manual(values = wes_palette("Moonrise3", n = 5)[2:4]) +
annotate("text", x=1500, y=10, label= text_box)
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/ADT_barplot_manual.png"), width = 10, height = 7)
################################################################################
####################### Doublets: ADT VS DoubletFinder #########################
################################################################################
table(seurat_obj$scDblFinder.class, seurat_obj$manual_ADT_class_cut_close_to_signal)
df <- as.data.frame(
table(
scDblFinder = seurat_obj$scDblFinder.class,
ADT_class   = seurat_obj$manual_ADT_class_cut_close_to_signal
)
)
ggplot(df, aes(x = ADT_class, y = scDblFinder, fill = Freq)) +
geom_tile(color = "white") +
geom_text(aes(label = Freq), size = 5) +
scale_fill_gradient(low = "grey90", high = "steelblue") +
labs(
x = "Manual ADT classification",
y = "scDblFinder classification",
fill = "Cell count"
) +
theme_minimal() +
theme(legend.position = "none")
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/demultiplexing/ADT_vs_scDblFinder_doublets.png"), width = 7, height = 4)
# New column to identify ADT singlets and scDblFinder doublets
# Potential communicating cells (!!!)
seurat_obj[[]] <- seurat_obj[[]] %>%
mutate(
ADT_singlet_scDblFinder_doublets = ifelse(scDblFinder.class == "doublet" & manual_ADT_class_cut_close_to_signal == "Singlet", TRUE, FALSE)
)
seurat_obj$ADT_singlet_scDblFinder_doublets %>% table()
DimPlot(seurat_obj, group.by = "ADT_singlet_scDblFinder_doublets", order = TRUE) +
labs(subtitle = sample_name, caption = "Potential communicating cells")
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/demultiplexing/UMAP_ADT_singlet_scDblFinder_doublets.png"), width = 8, height = 8)
DimPlot(seurat_obj, group.by = "Phase") +
labs(subtitle = sample_name)
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/demultiplexing/UMAP_Phase.png"), width = 8, height = 8)
FeaturePlot(seurat_obj, features = "nCount_RNA") +
labs(subtitle = sample_name)
ggsave(glue("10_ADT_demultiplex/plot/{sample_name}/demultiplexing/UMAP_nCount_RNA.png"), width = 8, height = 8)
# Load data
seurat_obj_nonDC_list <- readRDS("09_seurat_QC_clusters/out/seurat_obj_nonDC_list.rds")
seurat_obj_singlets_list <- readRDS("09_seurat_QC_clusters/out/seurat_obj_clustered_list_singlets.rds")
# Load data
seurat_obj_nonDC_list <- readRDS("09_seurat_QC_clusters/out/seurat_obj_nonDC_list.rds")
seurat_obj_singlets_list <- readRDS("09_seurat_QC_clusters/out/seurat_obj_clustered_list_singlets.rds")
seurat_obj_singlets_list
sample_names <- names(seurat_obj_singlets_list)
sample_names
sample_name <- "HH117-SI-PP-nonINF-HLADR-AND-CD19-AND-GC-AND-TFH"
seurat_obj<- seurat_obj_singlets_list[[sample_name]]
seurat_obj <- seurat_obj_singlets_list[[sample_name]]
seurat_obj
seurat_obj
Reductions(seurat_obj)
seurat_obj$merged_clusters
seurat_obj$scDblFinder.cluster
DimPlot(seurat_obj, group.by = "merged_clusters")
DimPlot(seurat_obj, group.by = "seurat_clusters")
DimPlot(seurat_obj, group.by = "seurat_clusters", label = TRUE) + NoLegend()
cluster.name <- "seurat_clusters"
# Find all markers
all_markers <- FindAllMarkers(seurat_object,
group.by = cluster.name)
# Find all markers
all_markers <- FindAllMarkers(seurat_obj,
group.by = cluster.name)
# rownames_to_column("gene")
head(all_markers)
# Process markers
top_markers_list <- all_markers %>%
filter(p_val_adj < 0.05) %>% # Filter for significant markers
group_by(cluster) %>%
# Sort by adjusted p-value (most significant) and then avg_log2FC (highest expression)
arrange(p_val_adj, desc(avg_log2FC), .by_group = TRUE) %>%
slice_head(n = 100) %>%
ungroup() %>%
# The split() function creates the named list needed for openxlsx
split(., .$cluster)
top_markers_list
# Export xlsx file
out_file <- glue("11_broad_annotation/out/{sample_name}_Top_100_DEGs.xlsx")
# Use openxlsx::write.xlsx, which takes the named list and writes
# each element as a separate sheet (sheet name = list name, i.e., Cluster ID)
openxlsx::write.xlsx(
x = top_markers_list,
file = out_file,
overwrite = TRUE # Overwrite the file if it already exists
)
# Process markers
top_markers_list <- all_markers %>%
filter(p_val_adj < 0.05) %>% # Filter for significant markers
group_by(cluster) %>%
# Sort by adjusted p-value (most significant) and then avg_log2FC (highest expression)
arrange(p_val_adj, desc(avg_log2FC), .by_group = TRUE) %>%
slice_head(n = 10) %>%
ungroup() %>%
# The split() function creates the named list needed for openxlsx
split(., .$cluster)
top_markers_list
source("11_broad_annotation/script/functions.R")
top_DEGs_to_excel(seurat_obj = seurat_obj, sample_name = sample_name)
source("11_broad_annotation/script/functions.R")
# Get top 100 DEGs
top_DEGs_to_excel(seurat_obj = seurat_obj, sample_name = sample_name, n_DEGs = 100)
sample_names <- names(seurat_obj_singlets_list)
# Get top 100 DEGs for each sample
lapply(sample_names, function(sample_name) {
seurat_obj <- seurat_obj_singlets_list[[sample_name]]
top_DEGs_to_excel(
seurat_obj = seurat_obj,
sample_name = sample_name,
n_DEGs = 100
)
})
sample_names <- names(seurat_obj_singlets_list)
sample_names
sample_name <- "HH117-SI-PP-nonINF-HLADR-AND-CD19-AND-GC-AND-TFH"
seurat_obj <- seurat_obj_singlets_list[[sample_name]]
cluster_to_celltype <- c(
"0" = "T_cells_CD4_like",
"1" = "T_cells_CD8_effector",
"2" = "Cycling_cells",
"3" = "Unclear_nonimmune",
"4" = "Plasma_cells",
"5" = "Low_quality_ribosomal",
"6" = "Dendritic_cells_myeloid",
"7" = "Low_quality_ambient",
"8" = "GC_B_cells",
"9" = "Plasmacytoid_DCs"
)
seurat_obj
sample_name
top_markers_list
# Process markers
top_markers_list <- all_markers %>%
filter(p_val_adj < 0.05) %>% # Filter for significant markers
group_by(cluster) %>%
# Sort by adjusted p-value (most significant) and then avg_log2FC (highest expression)
arrange(p_val_adj, desc(avg_log2FC), .by_group = TRUE) %>%
# slice_head(n = n_DEGs) %>%
slice_head(n = 50) %>%
ungroup() %>%
# The split() function creates the named list needed for openxlsx
split(., .$cluster)
top_markers_list
all_markers
cluster_to_celltype <- c(
"0" = "B_cells",
"1" = "T_cells",
"2" = "GC_B_cells",
"3" = "GC_B_cells",
"4" = "Plasma_cells",
"5" = "B_cells_low_quality_ribosomal",
"6" = "DCs",
"7" = "B_cells_low_quality_ambient",
"8" = "GC_B_cells",
"9" = "DCs"
)
seurat_obj$celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
]
cluster_to_celltype
seurat_obj$seurat_clusters
seurat_obj$celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
]
seurat_obj <- seurat_obj_singlets_list[[sample_name]]
cluster_to_celltype <- c(
"0" = "B_cells",
"1" = "T_cells",
"2" = "GC_B_cells",
"3" = "GC_B_cells",
"4" = "Plasma_cells",
"5" = "B_cells_low_quality_ribosomal",
"6" = "DCs",
"7" = "B_cells_low_quality_ambient",
"8" = "GC_B_cells",
"9" = "DCs"
)
seurat_obj$celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
]
cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
]
cluster_to_celltype
cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
]
length(cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
]
)
dim(seurat_obj)
celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
]
?AddMetaData
AddMetaData(seurat_obj,celltype_broad ,"celltype_broad")
celltype_broad
celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
] %>% as.data.frame()
celltype_broad
rownames(celltype_broad)
rownames(celltype_broad) <- colnames(seurat_obj)
AddMetaData(seurat_obj,celltype_broad ,"celltype_broad")
seurat_obj
seurat_obj <- AddMetaData(seurat_obj, celltype_broad, "celltype_broad")
# Check that mapping when correctly
table(seurat_obj$seurat_clusters, seurat_obj$celltype_broad)
# Map clusters to cell types
cluster_to_celltype <- c(
"0" = "B_cells",
"1" = "T_cells",
"2" = "GC_B_cells",
"3" = "GC_B_cells",
"4" = "Plasma_cells",
"5" = "B_cells_low_quality_ribosomal",
"6" = "DCs",
"7" = "B_cells_low_quality_ambient",
"8" = "GC_B_cells",
"9" = "DCs"
)
celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
] %>% as.data.frame()
rownames(celltype_broad) <- colnames(seurat_obj)
# Add broad cell type annotations
seurat_obj <- AddMetaData(seurat_obj, celltype_broad, "celltype_broad")
# Check that mapping when correctly
table(seurat_obj$seurat_clusters, seurat_obj$celltype_broad)
# See DimPlot
DimPlot(seurat_obj, group.by = "celltype_broad")
# See DimPlot
DimPlot(seurat_obj, group.by = "celltype_broad", label = TRUE) + NoLegend()
# Map clusters to cell types
cluster_to_celltype <- c(
"0" = "B_cells",
"1" = "T_cells",
"2" = "GC_B_cells",
"3" = "GC_B_cells",
"4" = "Plasma_cells",
"5" = "B_cells_ribosomal",
"6" = "DCs",
"7" = "B_cells_ambient",
"8" = "GC_B_cells",
"9" = "DCs"
)
celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
] %>% as.data.frame()
rownames(celltype_broad) <- colnames(seurat_obj)
# Add broad cell type annotations
seurat_obj <- AddMetaData(seurat_obj, celltype_broad, "celltype_broad")
# Check that mapping when correctly
table(seurat_obj$seurat_clusters, seurat_obj$celltype_broad)
# See DimPlot
DimPlot(seurat_obj, group.by = "celltype_broad", label = TRUE) + NoLegend()
# Map clusters to cell types
cluster_to_celltype <- c(
"0" = "Memory_B_cells",
"1" = "T_cells",
"2" = "GC_B_cells",
"3" = "GC_B_cells",
"4" = "Plasma_cells",
"5" = "B_cells_ribosomal",
"6" = "DCs",
"7" = "B_cells_ambient",
"8" = "GC_B_cells",
"9" = "DCs"
)
celltype_broad <- cluster_to_celltype[
as.character(seurat_obj$seurat_clusters)
] %>% as.data.frame()
rownames(celltype_broad) <- colnames(seurat_obj)
# Add broad cell type annotations
seurat_obj <- AddMetaData(seurat_obj, celltype_broad, "celltype_broad")
# Check that mapping when correctly
table(seurat_obj$seurat_clusters, seurat_obj$celltype_broad)
# See DimPlot
DimPlot(seurat_obj, group.by = "celltype_broad", label = TRUE) + NoLegend()
sample_names
